// ============================================================================
// foohut.com Prisma Schema
// Type-safe database schema definition with full relation mapping
// ============================================================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions", "fullTextSearch", "fullTextIndex"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [uuid_ossp(map: "uuid-ossp"), pgcrypto, vector, pg_trgm]
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  admin
  creator
  editor
  commenter
  visitor
}

enum PublishMode {
  public
  shareable
  private
  authenticated
}

enum ChangeRequestStatus {
  draft
  pending_review
  in_review
  approved
  rejected
  merged
  closed
}

enum SyncStatus {
  idle
  syncing
  success
  conflict
  error
}

enum BlockType {
  paragraph
  heading_1
  heading_2
  heading_3
  heading_4
  heading_5
  heading_6
  blockquote
  code_block
  table
  hint_info
  hint_warning
  hint_danger
  hint_success
  reusable_block
  image
  video
  embed
  math
  divider
  toggle
  tabs
  api_block
  file_attachment
  action_button
}

enum AuditAction {
  create
  update
  delete
  restore
  publish
  unpublish
  merge
  sync
  permission_change
  login
  logout
}

// ============================================================================
// CORE MODELS: Four-Tier Taxonomy
// ============================================================================

/// Root administrative container for billing, identity management, and user membership
model Organization {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  slug        String    @unique @db.VarChar(100)
  name        String    @db.VarChar(255)
  description String?   @db.Text
  logoUrl     String?   @map("logo_url") @db.Text
  settings    Json      @default("{}")
  billingInfo Json      @default("{}") @map("billing_info")

  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt   DateTime? @map("deleted_at") @db.Timestamptz

  // Relations
  collections OrganizationMember[]
  members     Collection[]
  auditLogs   AuditLog[]

  @@map("organizations")
}

/// Aggregation layer for Spaces with permission inheritance
model Collection {
  id                 String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  organizationId     String    @map("organization_id") @db.Uuid
  slug               String    @db.VarChar(100)
  name               String    @db.VarChar(255)
  description        String?   @db.Text
  icon               String?   @db.VarChar(50)
  position           Int       @default(0)
  settings           Json      @default("{}")
  inheritPermissions Boolean   @default(true) @map("inherit_permissions")

  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt          DateTime? @map("deleted_at") @db.Timestamptz

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  spaces       Space[]
  permissions  Permission[]

  @@unique([organizationId, slug])
  @@map("collections")
}

/// Fundamental unit of work with Git sync configuration
model Space {
  id                     String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  collectionId           String      @map("collection_id") @db.Uuid
  slug                   String      @db.VarChar(100)
  name                   String      @db.VarChar(255)
  description            String?     @db.Text
  icon                   String?     @db.VarChar(50)
  position               Int         @default(0)

  // Publishing
  publishMode            PublishMode @default(private) @map("publish_mode")
  customDomain           String?     @unique @map("custom_domain") @db.VarChar(255)
  customDomainVerified   Boolean     @default(false) @map("custom_domain_verified")
  shareableLinkToken     String      @default(dbgenerated("uuid_generate_v4()")) @map("shareable_link_token") @db.Uuid

  // Theme
  themeConfig            Json        @default("{}") @map("theme_config")

  // SEO
  seoTitle               String?     @map("seo_title") @db.VarChar(255)
  seoDescription         String?     @map("seo_description") @db.Text
  canonicalUrl           String?     @map("canonical_url") @db.Text

  settings               Json        @default("{}")

  createdAt              DateTime    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt              DateTime    @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt              DateTime?   @map("deleted_at") @db.Timestamptz

  // Relations
  collection       Collection         @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  pages            Page[]
  changeRequests   ChangeRequest[]
  gitSyncConfig    GitSyncConfig?
  searchIndex      SearchIndex[]
  apiSpecifications ApiSpecification[]
  permissions      Permission[]

  @@unique([collectionId, slug])
  @@map("spaces")
}

/// Granular content units with nested structure
model Page {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  spaceId       String    @map("space_id") @db.Uuid
  parentId      String?   @map("parent_id") @db.Uuid
  slug          String    @db.VarChar(255)
  title         String    @db.VarChar(500)
  description   String?   @db.Text
  icon          String?   @db.VarChar(50)

  // Nested structure
  path          String    @db.Text
  depth         Int       @default(0)
  position      Int       @default(0)

  // Page type
  pageType      String    @default("document") @map("page_type") @db.VarChar(50)
  templateId    String?   @map("template_id") @db.Uuid

  // Publishing
  isPublished   Boolean   @default(false) @map("is_published")
  publishedAt   DateTime? @map("published_at") @db.Timestamptz

  // SEO
  seoTitle      String?   @map("seo_title") @db.VarChar(255)
  seoDescription String?  @map("seo_description") @db.Text

  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz

  // Relations
  space              Space                   @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  parent             Page?                   @relation("PageHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children           Page[]                  @relation("PageHierarchy")
  blocks             Block[]
  versions           PageVersion[]
  changeRequestChanges ChangeRequestChange[]
  changeRequestComments ChangeRequestComment[]
  permissions        Permission[]

  @@unique([spaceId, path])
  @@map("pages")
}

// ============================================================================
// USER MANAGEMENT & RBAC
// ============================================================================

/// User accounts with multi-provider auth support
model User {
  id                   String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email                String    @unique @db.VarChar(255)
  emailVerified        Boolean   @default(false) @map("email_verified")
  passwordHash         String?   @map("password_hash") @db.Text

  // Profile
  displayName          String?   @map("display_name") @db.VarChar(255)
  avatarUrl            String?   @map("avatar_url") @db.Text
  bio                  String?   @db.Text

  // Auth
  authProvider         String    @default("email") @map("auth_provider") @db.VarChar(50)
  authProviderId       String?   @map("auth_provider_id") @db.VarChar(255)

  // Settings
  preferences          Json      @default("{}")
  notificationSettings Json      @default("{}") @map("notification_settings")

  // Status
  isActive             Boolean   @default(true) @map("is_active")
  lastLoginAt          DateTime? @map("last_login_at") @db.Timestamptz

  createdAt            DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt            DateTime? @map("deleted_at") @db.Timestamptz

  // Relations
  organizationMemberships OrganizationMember[]
  permissions             Permission[]
  sessions                Session[]
  pageVersions            PageVersion[]
  changeRequestsCreated   ChangeRequest[]       @relation("ChangeRequestCreator")
  changeRequestsMerged    ChangeRequest[]       @relation("ChangeRequestMerger")
  changeRequestComments   ChangeRequestComment[] @relation("CommentCreator")
  resolvedComments        ChangeRequestComment[] @relation("CommentResolver")
  invitationsSent         OrganizationMember[]  @relation("InvitedByUser")
  auditLogs               AuditLog[]

  @@map("users")
}

/// Organization membership with role assignment
model OrganizationMember {
  id             String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  userId         String    @map("user_id") @db.Uuid
  role           UserRole  @default(editor)

  // Invitation tracking
  invitedBy      String?   @map("invited_by") @db.Uuid
  invitedAt      DateTime? @map("invited_at") @db.Timestamptz
  acceptedAt     DateTime? @map("accepted_at") @db.Timestamptz

  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  inviter      User?        @relation("InvitedByUser", fields: [invitedBy], references: [id])

  @@unique([organizationId, userId])
  @@map("organization_members")
}

/// Granular permissions overriding organization-level roles
model Permission {
  id           String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  resourceType String   @map("resource_type") @db.VarChar(50)
  resourceId   String   @map("resource_id") @db.Uuid
  role         UserRole

  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  collection Collection? @relation(fields: [resourceId], references: [id], onDelete: Cascade, map: "permissions_collection_fk")
  space      Space?      @relation(fields: [resourceId], references: [id], onDelete: Cascade, map: "permissions_space_fk")
  page       Page?       @relation(fields: [resourceId], references: [id], onDelete: Cascade, map: "permissions_page_fk")

  @@unique([userId, resourceType, resourceId])
  @@map("permissions")
}

/// User sessions for auth tracking
model Session {
  id           String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId       String    @map("user_id") @db.Uuid
  tokenHash    String    @map("token_hash") @db.Text

  // Metadata
  ipAddress    String?   @map("ip_address") @db.Inet
  userAgent    String?   @map("user_agent") @db.Text
  deviceInfo   Json      @default("{}") @map("device_info")

  // Expiration
  expiresAt    DateTime  @map("expires_at") @db.Timestamptz
  lastActiveAt DateTime  @default(now()) @map("last_active_at") @db.Timestamptz

  // Revocation
  revokedAt    DateTime? @map("revoked_at") @db.Timestamptz
  revokedReason String?  @map("revoked_reason") @db.VarChar(255)

  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// ============================================================================
// CONTENT: Blocks and Versioning
// ============================================================================

/// Individual content units within pages
model Block {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  pageId          String    @map("page_id") @db.Uuid
  parentBlockId   String?   @map("parent_block_id") @db.Uuid

  blockType       BlockType @map("block_type")
  position        Int       @default(0)

  // Content as JSONB
  content         Json      @default("{}")

  // Code blocks
  language        String?   @db.VarChar(50)

  // Reusable blocks
  isReusable      Boolean   @default(false) @map("is_reusable")
  reusableBlockId String?   @map("reusable_block_id") @db.Uuid

  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt       DateTime? @map("deleted_at") @db.Timestamptz

  // Relations
  page           Page    @relation(fields: [pageId], references: [id], onDelete: Cascade)
  parentBlock    Block?  @relation("BlockHierarchy", fields: [parentBlockId], references: [id], onDelete: Cascade)
  childBlocks    Block[] @relation("BlockHierarchy")
  reusableSource Block?  @relation("ReusableBlock", fields: [reusableBlockId], references: [id])
  reusableUsages Block[] @relation("ReusableBlock")
  comments       ChangeRequestComment[]

  @@map("blocks")
}

/// Version history for pages
model PageVersion {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  pageId          String   @map("page_id") @db.Uuid
  versionNumber   Int      @map("version_number")

  title           String   @db.VarChar(500)
  contentSnapshot Json     @map("content_snapshot")

  createdBy       String?  @map("created_by") @db.Uuid
  changeSummary   String?  @map("change_summary") @db.Text

  gitCommitSha    String?  @map("git_commit_sha") @db.VarChar(40)

  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  page    Page  @relation(fields: [pageId], references: [id], onDelete: Cascade)
  creator User? @relation(fields: [createdBy], references: [id])

  @@unique([pageId, versionNumber])
  @@map("page_versions")
}

// ============================================================================
// CHANGE REQUESTS (Draft Workflow)
// ============================================================================

/// Draft workflow for collaborative editing
model ChangeRequest {
  id           String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  spaceId      String              @map("space_id") @db.Uuid

  title        String              @db.VarChar(500)
  description  String?             @db.Text
  status       ChangeRequestStatus @default(draft)

  // Branches
  sourceBranch String?             @map("source_branch") @db.VarChar(255)
  targetBranch String              @default("main") @map("target_branch") @db.VarChar(255)

  // Authorship
  createdBy    String              @map("created_by") @db.Uuid

  // Review
  reviewers    Json                @default("[]")
  approvedBy   String[]            @default([]) @map("approved_by") @db.Uuid

  // Merge
  mergedBy     String?             @map("merged_by") @db.Uuid
  mergedAt     DateTime?           @map("merged_at") @db.Timestamptz

  createdAt    DateTime            @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime            @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt    DateTime?           @map("deleted_at") @db.Timestamptz

  // Relations
  space    Space                   @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  creator  User                    @relation("ChangeRequestCreator", fields: [createdBy], references: [id])
  merger   User?                   @relation("ChangeRequestMerger", fields: [mergedBy], references: [id])
  changes  ChangeRequestChange[]
  comments ChangeRequestComment[]
  commits  GitCommit[]

  @@map("change_requests")
}

/// Changes within a change request
model ChangeRequestChange {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  changeRequestId String   @map("change_request_id") @db.Uuid
  pageId          String?  @map("page_id") @db.Uuid

  changeType      String   @map("change_type") @db.VarChar(20)

  beforeSnapshot  Json?    @map("before_snapshot")
  afterSnapshot   Json?    @map("after_snapshot")
  blockChanges    Json     @default("[]") @map("block_changes")

  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  changeRequest ChangeRequest @relation(fields: [changeRequestId], references: [id], onDelete: Cascade)
  page          Page?         @relation(fields: [pageId], references: [id], onDelete: SetNull)

  @@map("change_request_changes")
}

/// Comments on change requests
model ChangeRequestComment {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  changeRequestId String    @map("change_request_id") @db.Uuid

  pageId          String?   @map("page_id") @db.Uuid
  blockId         String?   @map("block_id") @db.Uuid
  lineNumber      Int?      @map("line_number")

  content         String    @db.Text

  // Threading
  parentCommentId String?   @map("parent_comment_id") @db.Uuid

  createdBy       String    @map("created_by") @db.Uuid

  // Resolution
  isResolved      Boolean   @default(false) @map("is_resolved")
  resolvedBy      String?   @map("resolved_by") @db.Uuid
  resolvedAt      DateTime? @map("resolved_at") @db.Timestamptz

  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt       DateTime? @map("deleted_at") @db.Timestamptz

  // Relations
  changeRequest ChangeRequest          @relation(fields: [changeRequestId], references: [id], onDelete: Cascade)
  page          Page?                  @relation(fields: [pageId], references: [id], onDelete: SetNull)
  block         Block?                 @relation(fields: [blockId], references: [id], onDelete: SetNull)
  parentComment ChangeRequestComment?  @relation("CommentThread", fields: [parentCommentId], references: [id], onDelete: Cascade)
  childComments ChangeRequestComment[] @relation("CommentThread")
  creator       User                   @relation("CommentCreator", fields: [createdBy], references: [id])
  resolver      User?                  @relation("CommentResolver", fields: [resolvedBy], references: [id])

  @@map("change_request_comments")
}

// ============================================================================
// GIT SYNCHRONIZATION
// ============================================================================

/// Git sync configuration per space
model GitSyncConfig {
  id                     String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  spaceId                String     @unique @map("space_id") @db.Uuid

  // Repository
  provider               String     @default("github") @db.VarChar(20)
  repositoryUrl          String     @map("repository_url") @db.Text
  repositoryOwner        String     @map("repository_owner") @db.VarChar(255)
  repositoryName         String     @map("repository_name") @db.VarChar(255)

  // Auth (encrypted)
  accessTokenEncrypted   String?    @map("access_token_encrypted") @db.Text
  webhookSecretEncrypted String?    @map("webhook_secret_encrypted") @db.Text

  // Settings
  defaultBranch          String     @default("main") @map("default_branch") @db.VarChar(255)
  rootPath               String     @default("./docs") @map("root_path") @db.VarChar(500)
  configFilePath         String     @default(".foohut.yaml") @map("config_file_path") @db.VarChar(255)

  // State
  syncStatus             SyncStatus @default(idle) @map("sync_status")
  lastSyncAt             DateTime?  @map("last_sync_at") @db.Timestamptz
  lastSyncCommit         String?    @map("last_sync_commit") @db.VarChar(40)
  lastError              String?    @map("last_error") @db.Text

  // Webhook
  webhookId              String?    @map("webhook_id") @db.VarChar(255)
  webhookActive          Boolean    @default(false) @map("webhook_active")

  // Auto sync
  autoSyncEnabled        Boolean    @default(true) @map("auto_sync_enabled")
  commitMessageTemplate  String     @default("docs: {summary} [foohut]") @map("commit_message_template") @db.Text

  createdAt              DateTime   @default(now()) @map("created_at") @db.Timestamptz
  updatedAt              DateTime   @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  space    Space       @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  commits  GitCommit[]
  branches GitBranch[]

  @@map("git_sync_configs")
}

/// Git commits tracking
model GitCommit {
  id                String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  gitSyncConfigId   String    @map("git_sync_config_id") @db.Uuid

  commitSha         String    @map("commit_sha") @db.VarChar(40)
  commitMessage     String?   @map("commit_message") @db.Text
  commitAuthor      String?   @map("commit_author") @db.VarChar(255)
  commitAuthorEmail String?   @map("commit_author_email") @db.VarChar(255)
  committedAt       DateTime? @map("committed_at") @db.Timestamptz

  direction         String    @db.VarChar(20)

  changeRequestId   String?   @map("change_request_id") @db.Uuid
  filesChanged      Json      @default("[]") @map("files_changed")

  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  gitSyncConfig GitSyncConfig  @relation(fields: [gitSyncConfigId], references: [id], onDelete: Cascade)
  changeRequest ChangeRequest? @relation(fields: [changeRequestId], references: [id])

  @@unique([gitSyncConfigId, commitSha])
  @@map("git_commits")
}

/// Git branches for multi-variant versioning
model GitBranch {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  gitSyncConfigId String   @map("git_sync_config_id") @db.Uuid

  branchName      String   @map("branch_name") @db.VarChar(255)
  displayLabel    String?  @map("display_label") @db.VarChar(255)

  headCommit      String?  @map("head_commit") @db.VarChar(40)
  isDefault       Boolean  @default(false) @map("is_default")
  isActive        Boolean  @default(true) @map("is_active")

  variantConfig   Json     @default("{}") @map("variant_config")

  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  gitSyncConfig GitSyncConfig @relation(fields: [gitSyncConfigId], references: [id], onDelete: Cascade)

  @@unique([gitSyncConfigId, branchName])
  @@map("git_branches")
}

// ============================================================================
// AI & EMBEDDINGS
// ============================================================================

/// Embeddings for semantic search (pgvector)
model Embedding {
  id           String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid

  sourceType   String   @map("source_type") @db.VarChar(50)
  sourceId     String   @map("source_id") @db.Uuid

  // Vector stored as Unsupported type (Prisma doesn't natively support vector)
  // Use raw queries for vector operations
  embedding    Unsupported("vector(1536)")

  contentHash  String   @map("content_hash") @db.VarChar(64)
  modelVersion String   @default("text-embedding-ada-002") @map("model_version") @db.VarChar(100)

  chunkIndex   Int      @default(0) @map("chunk_index")
  chunkText    String?  @map("chunk_text") @db.Text

  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz

  @@unique([sourceType, sourceId, chunkIndex])
  @@map("embeddings")
}

/// Search index for full-text search
model SearchIndex {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid

  sourceType    String   @map("source_type") @db.VarChar(50)
  sourceId      String   @map("source_id") @db.Uuid
  spaceId       String   @map("space_id") @db.Uuid

  title         String?  @db.Text
  content       String?  @db.Text

  // TSVector stored as Unsupported type
  titleVector   Unsupported("tsvector")? @map("title_vector")
  contentVector Unsupported("tsvector")? @map("content_vector")

  metadata      Json     @default("{}")
  boostScore    Float    @default(1.0) @map("boost_score")

  indexedAt     DateTime @default(now()) @map("indexed_at") @db.Timestamptz

  // Relations
  space Space @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  @@unique([sourceType, sourceId])
  @@map("search_index")
}

// ============================================================================
// AUDIT LOGGING
// ============================================================================

/// Immutable audit trail
model AuditLog {
  id             String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid

  userId         String?     @map("user_id") @db.Uuid
  userEmail      String?     @map("user_email") @db.VarChar(255)

  organizationId String?     @map("organization_id") @db.Uuid

  action         AuditAction
  resourceType   String      @map("resource_type") @db.VarChar(50)
  resourceId     String?     @map("resource_id") @db.Uuid
  resourceName   String?     @map("resource_name") @db.VarChar(500)

  oldValues      Json?       @map("old_values")
  newValues      Json?       @map("new_values")

  ipAddress      String?     @map("ip_address") @db.Inet
  userAgent      String?     @map("user_agent") @db.Text
  requestId      String?     @map("request_id") @db.Uuid

  createdAt      DateTime    @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  user         User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
}

// ============================================================================
// API DOCUMENTATION
// ============================================================================

/// OpenAPI specifications
model ApiSpecification {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  spaceId           String   @map("space_id") @db.Uuid

  name              String   @db.VarChar(255)
  version           String?  @db.VarChar(50)

  specFormat        String   @default("openapi") @map("spec_format") @db.VarChar(20)
  specVersion       String?  @map("spec_version") @db.VarChar(10)
  specContent       Json     @map("spec_content")

  sourceType        String   @map("source_type") @db.VarChar(20)
  sourceUrl         String?  @map("source_url") @db.Text

  autoSync          Boolean  @default(false) @map("auto_sync")
  syncIntervalHours Int      @default(6) @map("sync_interval_hours")
  lastSyncedAt      DateTime? @map("last_synced_at") @db.Timestamptz

  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  space Space @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  @@map("api_specifications")
}
